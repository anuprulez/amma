Differential gene expression in mice (germ free or normal, different ages, 2 genders)
=====================================================================================

# Biological context

## Questions

- What are the differentially expressed genes of the microglya cells between germ free (GF) and conventional (SPF) mice at different ages?
- Is there a difference between the ages?
- Is there a difference between the genders?
- Which genes? Which pathways?

## Hypotheses

- Differential gene expression between SPF and GF already known for 8 weeks mices ([article](http://www.nature.com/neuro/journal/v18/n7/abs/nn.4030.html))
- Expected gender bias in 104w SPF
- Differential gene expression between SPF and GF already known for embryonic and early mices ([article](https://www.sciencedirect.com/science/article/pii/S0092867417314320))

# Data

Microglia cells have been extracted from 64 mices given:
- 2 microbiota states: Conventional (SPF) and Germ free (GF)
- 3 ages: Young (8 weeks), Middle-aged (52 weeks), Old (104 weeks)
- 2 sexes: Female and Male 

Microbiote | Age | Sex | Number of samples
--- | --- | --- | --
GF | Middle-aged | Female | 6
GF | Middle-aged | Male | 4
GF | Old | Female | 3
GF | Old | Male | 5
GF | Young | Female | 5
GF | Young | Male | 4
SPF | Middle-aged | Female | 6
SPF | Middle-aged | Male | 5
SPF | Old | Female | 3
SPF | Old | Male | 14
SPF | Young | Female | 5
SPF | Young | Male | 4

Total RNA was extracted from FACS sorted CD11b+CD45lowLin- microglia cells using The ARCTURUS® PicoPure® RNA Isolation Kit (ThermoFisher) according to manufacturer’s protocol. The SMARTer Ultra Low Input RNA Kit for Sequencing v4 (Clontech Laboratories, Inc., Mountain View, CA, USA) was used to generate first strand cDNA from 500 to 750 pg total-RNA. Double stranded cDNA was amplified by LD PCR (11 cycles) and purified via magnetic bead clean-up.

Library preparation was carried out as described in the Illumina Nextera XT Sample Preparation Guide (Illumina, Inc., San Diego, CA, USA). 150 pg of input cDNA were tagmented (tagged and fragmented) by the Nextera XT transposome. The products were purified and amplified via a limited-cycle PCR program to generate multiplexed sequencing libraries. For the PCR step 1:5 dilutions of index 1 (i7) and index 2 (i5) primers were used. The libraries were quantified using the KAPA SYBR FAST ABI Prism Library Quantification Kit (Kapa Biosystems, Inc., Woburn, MA, USA). Equimolar amounts of each library were pooled, and the pools were used for cluster generation on the cBot with the Illumina TruSeq SR Cluster Kit v3.

The sequencing run was performed on a HiSeq 1000 instrument using the indexed, 50 cycles single-read (SR) protocol and the TruSeq SBS v3 Reagents according to the Illumina HiSeq 1000 System User Guide. Image analysis and base calling were converted into FASTQ files with the CASAVA1.8.2 software. Library preparation and RNAseq were performed at the Genomics Core Facility "KFB - Center of Excellence for Fluorescent Bioanalytics" (University of Regensburg, Regensburg, Germany).

# Analyses

## Extraction of read counts of the each genes for each samples

extraction of number of reads mapped on each annotated genes for each samples
[details](gene_count_extraction)

## Preparation of the differential expression analysis

Count data was first cleaned: 3 samples with low mapping rates (< 75%) or low number and rates of reads assigned to genes (< 55%), genes not find in any samples were removed, the genes names were checked using `rentrez` (1.2.1, Winter2017 ) and the metadata extracted and formatted. The details can be found [here](prepare_data). 

The **differential expression analysis** is performed with DESeq2 (1.14.1) Love2014 . The design model integrates the different factors (sex, microbiota and age) and their interaction: `Sex + Microbiota + Age + Sex:Age + Sex:Microbiota + Microbiota:Age`. The addition of each factor and interactions were tested and the number of genes with a significant adjusted p-values for the LRT (Likelihood Ratio Tests) were reported to show the percentage of variables' effect on transcriptomic profile. The details of this report as well as exploratory analysis and visualization of variance stabilizing transformation of the DESeq2 model can be found [here](dge_analysis).

Normalized counts generated by DESeq2 were checked for artefacts due to FACS sorting or contamination from other cell types that may have escaped the sorting gating. The gene list is based on single-cell RNA-sequencing data (Jordao2019 ). 3 samples and 30 markers genes of non microglia cell types were then removed.

**Clustering of the samples** based on the normalized counts was performed using hierarchical Ward clustering (Murtagh2014 ), implemented in the R (3.4.3) `stats` package to generate the dendogram ([Figure S1A](pre-visualization#With-all-genes)). [**Principal Components Analyses**](pre-visualization#With-all-genes#PCA-on-the-normalized-counts) were performed using the R (3.4.3) `stats` package:
1. on the full normalized counts and with several color codes to inspect the data
2. to compare the 2 microbiote states for the different combinations of age and sex.

[**Weighted gene co-expression network analysis**](pre-visualization#Gene-co-expression-analysis) (WGCNA, Zhang2005 ) was performed on the normalized expression data using the R package WGCNA (1.63, Langfelder2008 ). For computational efficiency, genes were filtered to keep only genes that have a at least 10 counts in more than 90% of the samples (10,277 kept genes and 9,417 removed). To obtain a signed hybrid network fulfilling the scale free topology, the soft-thresholding power parameter was set to 6. Co-expression modules were defined using a minimum module size of 65 genes and by merging modules with a module eigengene dissimilarity below 0.35 resulting in 9 modules having sizes between 117 and 1,627 genes. A [**module-trait correlation analysis**](pre-visualization#Relationship-between-modules-and-samples) was performed between the module eigengene (ME) and the different trait (combination of microbiote, age and sex): correlation of Pearson between each pair of variables and Student asymptotic p-values for the correlations, computed using the WGCNA package. The [**SinaPlot**](pre-visualization#Sinaplots-of-the-Z-scores-per-groups) (Sidiropoulos2018 ) of the mean Z-scores of genes in the different MEs are plotted using the sinaplot (1.1.0) package. The [**Gene Ontology enrichment analysis**](pre-visualization#Enrichment-analysis-in-modules) of the genes in the different MEs was performed using `goseq` (1.26.0, Young2010 ), with the genome wide annotation for Mouse `org.Mm.eg.db` (3.4.0) and the Wallenius approximation. The over enriched GO categories were extracted using a 0.05 FDR cutoff (Benjamini1995 ). 

## Analyses of the differentially expressed genes given different comparisons

The differential expressed genes were identified and analyzed for different comparisons: microbiote effect (GF vs SPF), sex effect (Male vs Female) and age effect (Middle-aged vs Young, Old vs Young and Old vs Middle-aged). For these comparisons, several aspects were checked: 
1. effect alone, after controlling for other factor (e.g. microbiote effect alone, after controlling for age and sex)
2. effect for the different levels on each levels of one extra factor (e.g. microbiote effect for both sexes, after controlling for age)
3. effect for the different levels on each levels of both extra factors (e.g. microbiote effect for both sexes and 3 ages)

These different analyses were done following the same procedure. The differentially expressed genes (DEGs) showing adjusted p-values (Wald test) less than 0.05 and absolute fold change greater than 1.5 were identified. The heatmaps for Z-scores of DEGs are plotted using `pheatmap` (1.0.8) with hierarchical clustering of the rows (complete method). The enrichment analyses (Gene Ontology and KEGG) for the DEGs were performed using `goseq` (1.26.0, Young2010 ), with the genome wide annotation for Mouse `org.Mm.eg.db` (3.4.0) and the Wallenius approximation. The over and under enriched categories were extracted using a 0.05 FDR cutoff (Benjamini1995 ). Networks of GO terms were generated using `RamiGO` (1.20.0, Markus2013 ) and the KEGG pathways using `pathview` (1.14.0, Luo2013 ).

### Effect of the microbiote (GF vs SPF) on the expressed genes

Analysis | Report | Sources | Data
--- | --- | --- | ---
Microbiote effect, after controlling for age and sex | [Report](microbiote-effect-general) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/microbiote-effect-general) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/microbiote-effect/microbiote)
Microbiote effect for both sexes, after controlling for age | [Report](microbiote-effect-sex) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/microbiote-effect-sex) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/microbiote-effect/microbiote_sex)
Microbiote effect for the 3 ages, after controlling for sex | [Report](microbiote-effect-age) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/microbiote-effect-age) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/microbiote-effect/microbiote_age)
Microbiote effect for the 3 ages and both sexes | [Report](microbiote-effect-age-sex) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/microbiote-effect-age-sex) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/microbiote-effect/microbiote_sex_age)

### Effect of the sex (Male vs Female) on the expressed genes

Analysis | Report | Sources | Data
--- | --- | --- | ---
Sex effect, after controlling for age and microbiote | [Report](sex-effect-general) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/sex-effect-general) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/sex-effect/sex)
Sex effect for both microbiotes, after controlling for age | [Report](sex-effect-microbiote) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/sex-effect-microbiote) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/sex-effect/sex-microbiote)
Sex effect for the 3 ages, after controlling for microbiote | [Report](sex-effect-age) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/sex-effect-age) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/sex-effect/sex-age)
Sex effect for the 3 ages and both microbiotes | [Report](sex-effect-age-microbiote) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/sex-effect-age-microbiote) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/sex-effect/sex-age-microbiote)

### Effect of the ages (Middle-aged vs Young, Old vs Young and Old vs Middle-aged) on the expressed genes

Analysis | Report | Sources | Data
--- | --- | --- | ---
Age effect, after controlling for sex and microbiote | [Report](age-effect-general) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/age-effect-general) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/age-effect/age)
Age effect for both microbiotes, after controlling for sex | [Report](age-effect-microbiote) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/age-effect-microbiote) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/age-effect/age-microbiote)
Age effect for the both sexes, after controlling for microbiote | [Report](age-effect-sex) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/age-effect-sex) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/age-effect/age-sex)
Age effect for the both sexes and both microbiotes | [Report](age-effect-sex-microbiote) | [Sources](https://github.com/bebatut/neuromac_GF_mices/tree/master/src/age-effect-sex-microbiote) | [Data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/age-effect/age-sex-microbiote)

## Genes confirmed as a core signature for homeostatic microglia

[Genes confirmed as a core signature for homeostatic microglia](homeostatic_core_signature_genes) - [data](https://github.com/bebatut/neuromac_GF_mices/tree/master/results/dge/homeostatic_core_signature_genes/)

## Comparison of GF and SPF 8w Female to GF 8w Female with added microbiota (young or old)

[Comparison of GF and SPF 8w Female to GF 8w Female with added microbiota (young or old)](added_microbiota)